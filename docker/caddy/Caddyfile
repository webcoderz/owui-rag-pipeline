# Caddy: NVIDIA RAG subpaths + Open WebUI as default.
# /ingestor -> 8082, /rag -> 8081; everything else -> Open WebUI (8080).
# Uses replace_response so Swagger at /rag/docs and /ingestor/docs load the spec and Try it out correctly.

{
  admin off
}

:80 {
  # Ingestor service: /ingestor/* -> ingestor-server:8082
  handle_path /ingestor/* {
    replace {
      match header Content-Type text/html*
      "/openapi.json" "/ingestor/openapi.json"
    }
    replace {
      match header Content-Type application/json*
      "\"url\": \"/\"" "\"url\": \"/ingestor\""
    }
    reverse_proxy ingestor-server:8082 {
      header_up Accept-Encoding identity
    }
  }
  handle /ingestor {
    redir /ingestor/ permanent
  }

  # RAG service: /rag/* -> rag-server:8081
  handle_path /rag/* {
    replace {
      match header Content-Type text/html*
      "/openapi.json" "/rag/openapi.json"
    }
    replace {
      match header Content-Type application/json*
      "\"url\": \"/\"" "\"url\": \"/rag\""
    }
    reverse_proxy rag-server:8081 {
      header_up Accept-Encoding identity
    }
  }
  handle /rag {
    redir /rag/ permanent
  }

  # Everything else -> Open WebUI (must be last)
  handle {
    reverse_proxy open-webui:8080
  }
}
